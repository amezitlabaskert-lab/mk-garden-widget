<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mezítlábas Kert Master v12.4</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background: transparent; font-family: 'Plus Jakarta Sans', sans-serif; color: #636363; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* --- KERTFIGYELŐ STÍLUSOK (SZÖGLETES) --- */
        .garden-main-card { background: #ffffff; padding: 18px; display: flex; flex-direction: column; box-sizing: border-box; min-height: 480px; height: auto; border-radius: 0; }
        .garden-title { font-family: 'Dancing Script', cursive; font-size: 3.2em; font-weight: 700; text-align: center; margin: 5px 0 12px 0; color: #1a1a1a; line-height: 1.1; }
        .section-title { font-weight: 800; font-size: 14px; text-transform: uppercase; letter-spacing: 1.2px; margin: 12px 0 8px 0; padding-bottom: 4px; border-bottom: 1px solid rgba(0,0,0,0.06); color: #64748b; }
        .carousel-wrapper { position: relative; height: 140px; margin-bottom: 5px; overflow: hidden; }
        .carousel-item { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; visibility: hidden; transition: opacity 1.2s ease-in-out; display: flex; flex-direction: column; justify-content: center; }
        .carousel-item.active { opacity: 1; visibility: visible; }
        .card-container { position: relative; padding-left: 14px; width: 100%; box-sizing: border-box; }
        .card-line { position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .card-type-alert { background: #b91c1c; } .card-type-window { background: #2d6a4f; } .card-type-info { background: #6691b3; }
        .event-name { font-weight: 800; font-size: 16px; margin-bottom: 2px; color: #1e293b; line-height: 1.2; }
        .event-msg { font-size: 14px; line-height: 1.45; color: #334155; }
        .loc-btn { width: 100%; cursor: pointer; padding: 10px; font-size: 10px; font-weight: 800; border: none; background: #475569; color: white; text-transform: uppercase; margin-bottom: 5px; border-radius: 0; }
        .garden-footer { text-align: center; font-size: 9px; margin-top: auto; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.05); opacity: 0.7; line-height: 1.4; text-transform: uppercase; font-weight: 700; }

        /* --- IDŐJÁRÁS STÍLUSOK --- */
        .idojaras-widget { background: #ffffff; padding: 15px 20px; box-sizing: border-box; width: 100%; border-radius: 0; }
        .top-row { display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .now-temp-text { font-size: 38px; font-weight: 800; letter-spacing: -1.5px; }
        .forecast-mini-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; flex-grow: 1; }
        .mini-day-card { text-align: center; }
        .mini-day-title { font-size: 10px; font-weight: 700; color: #999; text-transform: uppercase; }
        .mini-day-temps { font-size: 12px; font-weight: 800; }
        .temp-max { color: #e67e22; } .temp-min { color: #3498db; }
        .soil-compact-row { display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #f8f8f8; margin-top: 10px; }
        .soil-label { font-size: 9px; font-weight: 800; color: #999; text-transform: uppercase; }
        .soil-val { font-size: 16px; font-weight: 800; display: block; margin-top: 2px; }
        .chart-container { height: 110px; border-top: 1px solid #f0f0f0; padding-top: 10px; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="view-gomb" class="hidden">
        <div id="kertfigyelo-root"></div>
    </div>

    <div id="view-adatok" class="hidden">
        <div class="idojaras-widget">
            <div class="top-row">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div id="now-icon-anim" style="width: 80px; height: 80px;"></div>
                    <div>
                        <div class="now-temp-text"><span id="now-temp-val">--</span>°C</div>
                        <div id="now-status-label" style="font-size:10px; font-weight:700; color:#999; text-transform:uppercase;"></div>
                    </div>
                </div>
                <div class="forecast-mini-grid" id="daily-grid-container"></div>
            </div>
            <div class="soil-compact-row">
                <div class="soil-item"><span class="soil-label">Páratartalom</span><span id="hum-val" class="soil-val">--%</span></div>
                <div class="soil-item"><span class="soil-label">Talajnedvesség</span><span id="moist-val" class="soil-val">--%</span></div>
                <div class="soil-item"><span class="soil-label">Vízmérleg</span><span id="evapo-val" class="soil-val">-- mm</span></div>
                <div class="soil-item"><span class="soil-label">Talajhő</span><span id="s6-val" class="soil-val">--°C</span></div>
            </div>
            <div class="chart-container"><canvas id="finalChart"></canvas></div>
            <div style="display:flex; justify-content:space-between; font-size:9px; font-weight:800; color:#999; padding-top:8px; text-transform:uppercase;">
                <div id="footer-left-weather">...</div>
                <div id="footer-right-weather">...</div>
            </div>
        </div>
    </div>

    <script>
        const APP_VERSION = "v12.4";
        const mode = window.location.hash.replace('#', '') || 'GOMB';
        const ICON_BASE = "https://basmilius.github.io/weather-icons/production/fill/all/";
        const WMO_MAP = { 0: { label: 'Derült', d: 'clear-day.svg', n: 'clear-night.svg' }, 1: { label: 'Derűs', d: 'partly-cloudy-day.svg', n: 'partly-cloudy-night.svg' }, 2: { label: 'Részben felhős', d: 'partly-cloudy-day.svg', n: 'partly-cloudy-night.svg' }, 3: { label: 'Borult', d: 'cloudy.svg', n: 'cloudy.svg' }, 45: { label: 'Ködös', d: 'fog.svg', n: 'fog.svg' }, 48: { label: 'Zúzmarás köd', d: 'fog.svg', n: 'fog.svg' }, 51: { label: 'Gyenge szitálás', d: 'drizzle.svg', n: 'drizzle.svg' }, 53: { label: 'Szitálás', d: 'drizzle.svg', n: 'drizzle.svg' }, 55: { label: 'Erős szitálás', d: 'drizzle.svg', n: 'drizzle.svg' }, 56: { label: 'Zúzmarás szitálás', d: 'drizzle.svg', n: 'drizzle.svg' }, 57: { label: 'Erős zúzmarás szitálás', d: 'drizzle.svg', n: 'drizzle.svg' }, 61: { label: 'Gyenge eső', d: 'rain.svg', n: 'rain.svg' }, 63: { label: 'Eső', d: 'rain.svg', n: 'rain.svg' }, 65: { label: 'Heves eső', d: 'extreme-rain.svg', n: 'extreme-rain.svg' }, 66: { label: 'Ónos eső', d: 'sleet.svg', n: 'sleet.svg' }, 67: { label: 'Erős ónos eső', d: 'sleet.svg', n: 'sleet.svg' }, 71: { label: 'Hószállingózás', d: 'snow.svg', n: 'snow.svg' }, 73: { label: 'Havazás', d: 'snow.svg', n: 'snow.svg' }, 75: { label: 'Erős havazás', d: 'extreme-snow.svg', n: 'extreme-snow.svg' }, 77: { label: 'Hószemcsék', d: 'snow.svg', n: 'snow.svg' }, 80: { label: 'Gyenge zápor', d: 'partly-cloudy-day-rain.svg', n: 'partly-cloudy-night-rain.svg' }, 81: { label: 'Zápor', d: 'rain.svg', n: 'rain.svg' }, 82: { label: 'Heves zápor', d: 'extreme-day-rain.svg', n: 'extreme-night-rain.svg' }, 85: { label: 'Hózápor', d: 'partly-cloudy-day-snow.svg', n: 'partly-cloudy-night-snow.svg' }, 86: { label: 'Heves hózápor', d: 'extreme-day-snow.svg', n: 'extreme-night-snow.svg' }, 95: { label: 'Zivatar', d: 'thunderstorms-day-rain.svg', n: 'thunderstorms-night-rain.svg' }, 96: { label: 'Zivatar jégesővel', d: 'thunderstorms-day-extreme.svg', n: 'thunderstorms-night-extreme.svg' }, 99: { label: 'Heves zivatar', d: 'thunderstorms-extreme-rain.svg', n: 'thunderstorms-extreme-rain.svg' } };

        async function init() {
            const lat = localStorage.getItem('garden-lat') || "47.5136";
            const lon = localStorage.getItem('garden-lon') || "19.3735";
            const isPers = !!localStorage.getItem('garden-lat');
            const data = await getSharedData(lat, lon);

            if (mode === 'GOMB') {
                document.getElementById('view-gomb').classList.remove('hidden');
                renderGarden(data, isPers);
            } else {
                document.getElementById('view-adatok').classList.remove('hidden');
                renderWeather(data, isPers);
            }
        }

        async function getSharedData(lat, lon) {
            const cacheKey = `shared_v12_4_${lat}_${lon}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                const p = JSON.parse(cached);
                if (Date.now() - p.ts < 900000) return p.data;
            }

            const now = new Date(), today = now.toISOString().split('T')[0];
            const [forecast, histCurr, histPrev, rules] = await Promise.all([
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=is_day,weather_code&hourly=temperature_2m,relative_humidity_2m,soil_temperature_6cm,soil_moisture_3_to_9cm&daily=weathercode,temperature_2m_max,temperature_2m_min,et0_fao_evapotranspiration,precipitation_sum,wind_speed_10m_max,wind_gusts_10m_max,snowfall_sum&timezone=auto&past_days=7&forecast_days=7`).then(r => r.json()),
                fetch(`https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${now.getFullYear()}-01-01&end_date=${today}&daily=precipitation_sum&timezone=auto`).then(r => r.json()),
                fetch(`https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${now.getFullYear()-1}-01-01&end_date=${now.getFullYear()-1}-12-31&daily=precipitation_sum&timezone=auto`).then(r => r.json()),
                fetch(`https://raw.githack.com/amezitlabaskert-lab/kertfigyelo/main/kertfigyelo_esemenyek.json?v=${Date.now()}`).then(r => r.json())
            ]);

            const full = { forecast, histCurr, histPrev, rules, ts: Date.now() };
            localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), data: full }));
            return full;
        }

        function checkCondition(f, idx, key, val, dry) {
            const d = f.daily;
            if (key === 'temp_max_below') return d.temperature_2m_max[idx] <= val;
            if (key === 'temp_min_below') return d.temperature_2m_min[idx] <= val;
            if (key === 'temp_min_above') return d.temperature_2m_min[idx] >= val;
            if (key === 'temp_above') return d.temperature_2m_max[idx] >= val;
            if (key.startsWith('rain_min')) return d.precipitation_sum[idx] >= val;
            if (key.startsWith('rain_max')) return d.precipitation_sum[idx] <= val;
            if (key.includes('wind_gusts')) return d.wind_gusts_10m_max[idx] >= val;
            if (key.includes('snow')) return d.snowfall_sum[idx] >= val;
            if (key === 'days_min') return dry >= val;
            if (key === 'days_max') return dry <= val;
            return true;
        }

        function checkSustained(f, idx, rule, dry) {
            const c = rule.conditions || {}; const days = c.days_min || 1;
            if (idx < days - 1) return false;
            for (const k in c) {
                if (k === 'days_min' || k === 'days_max') continue;
                for (let j = 0; j < days; j++) if (!checkCondition(f, idx - j, k, c[k], dry)) return false;
            }
            return true;
        }

        function renderGarden(data, isPers) {
            if (data.forecast.daily.precipitation_sum[7] >= 8) localStorage.setItem('last_rain_date', data.forecast.daily.time[7]);
            const lastRain = localStorage.getItem('last_rain_date');
            const dryDays = lastRain ? Math.floor(Math.abs(new Date() - new Date(lastRain)) / 86400000) : 0;
            const results = [];

            data.rules.forEach(rule => {
                let range = null;
                for (let i = 7; i < data.forecast.daily.time.length; i++) {
                    const d = new Date(data.forecast.daily.time[i]);
                    const inSeason = !rule.seasons || rule.seasons.some(s => {
                        const [sM, sD] = s.start.split('-').map(Number), [eM, eD] = s.end.split('-').map(Number);
                        const sDate = new Date(d.getFullYear(), sM-1, sD), eDate = new Date(d.getFullYear(), eM-1, eD);
                        return eDate < sDate ? (d >= sDate || d <= eDate) : (d >= sDate && d <= eDate);
                    });
                    if (inSeason && checkSustained(data.forecast, i, rule, dryDays)) {
                        if (!range) range = { start: d, end: d }; else range.end = d;
                    } else if (range) break;
                }
                if (range) results.push({ ...rule, start: range.start, end: range.end });
            });

            const alerts = results.filter(r => r.type === 'alert'), others = results.filter(r => r.type !== 'alert');
            const locName = isPers ? "AZ ÉN KERTEM" : "A MEZÍTLÁBAS KERT BÁZISA";
            const updateTime = new Date(data.ts).toLocaleTimeString('hu-HU', {hour: '2-digit', minute:'2-digit'});

            document.getElementById('kertfigyelo-root').innerHTML = `
                <div class="garden-main-card">
                    <div class="garden-title">${isPers ? 'Kertfigyelőd' : 'Kertfigyelő'}</div>
                    <button class="loc-btn" onclick="toggleLoc(${isPers})">${isPers ? 'Vissza az alaphoz' : 'Saját kertfigyelőt!'}</button>
                    <div class="section-title">Riasztások</div>${renderCarousel(alerts, 'alert', dryDays)}
                    <div class="section-title">Teendők & Info</div>${renderCarousel(others, 'task', dryDays)}
                    <div class="garden-footer">
                        HELYSZÍN: ${locName}<br>
                        FRISSÍTVE: ${updateTime} | ${APP_VERSION}
                    </div>
                </div>`;
            initCarousels();
        }

        function renderWeather(data, isPers) {
            const f = data.forecast, now = new Date();
            const hIdx = f.hourly.time.findIndex(t => new Date(t) > now) - 1;
            
            document.getElementById('now-temp-val').innerText = Math.round(f.hourly.temperature_2m[hIdx]);
            document.getElementById('hum-val').innerText = f.hourly.relative_humidity_2m[hIdx] + '%';
            document.getElementById('moist-val').innerText = (f.hourly.soil_moisture_3_to_9cm[hIdx] * 100).toFixed(1) + '%';
            document.getElementById('s6-val').innerText = f.hourly.soil_temperature_6cm[hIdx].toFixed(1);

            const w = WMO_MAP[f.current.weather_code] || WMO_MAP[0];
            document.getElementById('now-icon-anim').innerHTML = `<img src="${ICON_BASE}${f.current.is_day ? w.d : w.n}" style="width:80px;">`;
            document.getElementById('now-status-label').innerText = w.label;
            
            const bal = (f.daily.precipitation_sum[0] || 0) - (f.daily.et0_fao_evapotranspiration[0] || 0);
            document.getElementById('evapo-val').innerText = (bal > 0 ? '+' : '') + bal.toFixed(1) + ' mm';

            let gridHtml = ""; const DAYS = ["VAS", "HÉT", "KEDD", "SZE", "CSÜ", "PÉN", "SZO"];
            for(let i=1; i<=3; i++) {
                const d = new Date(f.daily.time[i]), wd = WMO_MAP[f.daily.weathercode[i]] || WMO_MAP[0];
                gridHtml += `<div class="mini-day-card"><div class="mini-day-title">${DAYS[d.getDay()]}</div><img src="${ICON_BASE}${wd.d}" style="width:30px;"><div class="mini-day-temps"><span class="temp-max">${Math.round(f.daily.temperature_2m_max[i])}°</span> <span class="temp-min">${Math.round(f.daily.temperature_2m_min[i])}°</span></div></div>`;
            }
            document.getElementById('daily-grid-container').innerHTML = gridHtml;

            const monthLabels = ['Jan', 'Feb', 'Márc', 'Ápr', 'Máj', 'Jún', 'Júl', 'Aug', 'Szept', 'Okt', 'Nov', 'Dec'];
            const curYear = new Array(12).fill(0);
            const prevYear = new Array(12).fill(0);

            data.histCurr.daily.precipitation_sum.forEach((r, i) => {
                const m = new Date(data.histCurr.daily.time[i]).getMonth();
                curYear[m] += (r || 0);
            });
            data.histPrev.daily.precipitation_sum.forEach((r, i) => {
                const m = new Date(data.histPrev.daily.time[i]).getMonth();
                prevYear[m] += (r || 0);
            });

            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(document.getElementById('finalChart'), {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: [
                        { label: 'Tavaly', data: prevYear, backgroundColor: 'rgba(200, 200, 200, 0.4)', borderRadius: 0, barPercentage: 0.8 },
                        { label: 'Idén', data: curYear, backgroundColor: '#3498db', borderRadius: 0, barPercentage: 0.8 }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 9, weight: 'bold' } } } }
                }
            });
            
            const sumCur = Math.round(curYear.reduce((a,b)=>a+b, 0));
            const sumPrev = Math.round(prevYear.reduce((a,b)=>a+b, 0));
            const kertNev = isPers ? "AZ ÉN KERTEMBEN" : "A MEZÍTLÁBAS KERTBEN";
            document.getElementById('footer-left-weather').innerText = `ESŐ ${kertNev}`;
            document.getElementById('footer-right-weather').innerText = `IDÉN: ${sumCur} | TAVALY: ${sumPrev} MM [${APP_VERSION}]`;
        }

        function renderCarousel(items, id, dry) {
            if (!items.length) return `<div class="carousel-wrapper" style="opacity:0.3; display:flex; align-items:center; justify-content:center;">Nincs aktuális esemény</div>`;
            return `<div id="${id}-carousel" class="carousel-wrapper">${items.map((item, idx) => `
                <div class="carousel-item ${idx===0?'active':''}">
                    <div class="card-container">
                        <div class="card-line card-type-${item.type}"></div>
                        <div class="event-name">${item.name}</div>
                        <div class="event-msg">${item.message.replace('{days}', dry)}</div>
                    </div>
                </div>`).join('')}</div>`;
        }

        function initCarousels() {
            document.querySelectorAll('.carousel-wrapper').forEach(w => {
                const items = w.querySelectorAll('.carousel-item'); if (items.length <= 1) return;
                let i = 0; setInterval(() => { items[i].classList.remove('active'); i = (i + 1) % items.length; items[i].classList.add('active'); }, 6000);
            });
        }

        function toggleLoc(isPers) {
            if (isPers) { localStorage.clear(); location.reload(); }
            else { navigator.geolocation.getCurrentPosition(p => { localStorage.setItem('garden-lat', p.coords.latitude); localStorage.setItem('garden-lon', p.coords.longitude); location.reload(); }); }
        }

        init();
    </script>
</body>
</html>
